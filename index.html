<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClimaApp</title>

    <!--Bootstrap-->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    
    <!--JQuery-->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!--CSS-->

    <style>
        
        :root{

            --bgColorCartao:deepskyblue;

        }

        body{

            background-size: 100vw 100vh;
            width: 100vw; height: 100vh;

        }

        div#msgErro{

            position: absolute;
            left: 50%;
            bottom: 3%;
            transform: translateX(-50%);
            z-index: 998;
            
        }

        div.cartao{

            width: 250px;
            height: 280px;
            position: relative;
            padding: 7px 15px;
            background-color: var(--bgColorCartao);
            margin: 10px;

        }

        p{

            margin: 0;

        }

        p.tempMinMax{

            font-size: 0.8rem;

        }

        p#descricao{

            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            width: max-content;

        }

        .center{

            position: absolute;
            left: 50%; top: 50%;
            transform: translate(-50%,-50%);

        }

        .modal{

            background-color: rgba(0, 0, 0, 0.459);

        }

        button#abrirJanela{

            display: none;

        }

        @media screen and (orientation: portrait){

            body{

                background-size: cover;
                background-position: center;

            }

        }

    </style>

</head>
<body class = "p-4">
    
    <div id = "msgErro"></div>
    <div id = "janela"></div>

    <form class = "d-flex justify-content-center">
        
        <div class="input-group">

            <input placeholder = "Digite uma cidade..." class = "form-control" id = "cidade" required type="text"> 
        
            <div class = "input-group-append">
    
                <button class ="btn btn-primary">Pesquisar</button>
    
            </div>    

        </div>

    </form>

    <div class="w-100 h-50 center p-4" id = cartoes>

        <div class = "w-100 h-100 position-relative d-flex justify-content-center" id = "conteudo"></div>

    </div>

    <div id = "janela">
        
        <div class="modal fade" id="modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="titulo-janela"></h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id = "texto-janela"></p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-success" data-bs-dismiss="modal">Okay!</button>
                </div>
              </div>
            </div>
          </div>

          <button id = "abrirJanela" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal">
          </button>

    </div>

    <script>

        function verificarOrientacao(e, callback){

            if (e.matches){

                orientacao = "portrait";

                callback();

            } else{

                orientacao = "landscape"

            }

        }

        function capitalize(texto){

            return texto.charAt(0).toUpperCase() + texto.slice(1)

        }

        function limparInput(){

            $("input#cidade").val("")
            $("input#cidade").focus();

        }

        function criarCartao(clima){

            const nomeCidadeClass = clima.nomeCidade.length >= 19 ? "fs-5" : "fs-4";

            if (orientacao == "portrait"){

                $("div#cartoes>div#conteudo>div.cartao").remove();
                cidadesPesquisadas.shift();

            }

            $(`<div class = "cartao text-white rounded my-2">
            
                <div id = "conteudo">

                    <p class = "${nomeCidadeClass} text-center">${clima.nomeCidade}</p>

                    <div class = "text-end" id = "temps">
                        <p class = "fs-2">${clima.temp}°C</p>
                        <p class = "tempMinMax">Min:${clima.temp_min}°C</p>
                        <p class = "tempMinMax">Max:${clima.temp_max}°C</p>
                    </div>

                    <img class = "center" id = "tempoIcon" src = ${clima.iconUrl}>

                    <p id = "descricao">${clima.descricao}</p>

                </div>

            </div>`).appendTo("div#cartoes>div#conteudo").hide().fadeIn(300);

            limparInput()

        }

        function excluirCartoes(){

            let cartoes = $("div#cartoes>div#conteudo>div.cartao");

            for (let i = 0; i < cartoes.length; i++){

                if (i >= cartoes.length-1){

                    break;

                }

                cartoes[i].remove();
                cidadesPesquisadas.shift();

            }

        }

        function verificarNomeCidade(nomeCidade){

            if (nomeCidade == false){tratarErro("inputVazio"); return true} 

            for (let i = 0; i < cidadesPesquisadas.length; i++){

                if (nomeCidade == cidadesPesquisadas[i]){

                    tratarErro("cidadeJaPesquisada");
                    limparInput();
                    return true;

                }

            }

            return false;

        }

        function tratarErro(codigoErro){

            const mensagensDeErro = {

                404: "Cidade não encontrada!",
                inputVazio: "Você não digitou nenhuma cidade!",
                cidadeJaPesquisada: "Essa cidade já foi pesquisada"

            }

            $("div#msgErro>div") ? $("div#msgErro>div").remove() : "";

            $("div#msgErro").append($(`
            
            <div class="text-center alert alert-danger alert-dismissible" role="alert">
                ${mensagensDeErro[codigoErro]}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            `)).hide().fadeIn(300);

        }

        const apiKey = "d7f4c82d800ee3b805b4eda5749983d9";

        function obterCoordenadasPorGeoLocation(callback){

            if (navigator.geolocation){

                navigator.permissions.query({name:'geolocation'})
                .then((permissionStatus)=>{
                    verificarPermissao(permissionStatus)
                    permissionStatus.onchange = ()=> location.reload(true);
                })
            
            } else{

                console.log("Navegador não suporta GeoLocalização!")

            }

            function verificarPermissao(permissionStatus){

                if (permissionStatus.state == "prompt"){
                    abrirJanela(
                    "Permitir localização",
                    "Permita acessarmos sua localização para que possamos exibir a temperatura em sua localização atual."
                    )
                }

                navigator.geolocation.getCurrentPosition(
                    function(position){

                        const coords = {

                            lat: position.coords.latitude,
                            lon: position.coords.longitude,

                        }

                        obterNomeCidadePorCoordenadas(coords).then(nomeCidade=>{callback(coords, nomeCidade)});

                    },
                    function(error){

                        console.log(error);

                    }
                )
            }
        }

        function obterCoordenadasPorNomeCidade(nomeCidade, callback){

            const url = `https://api.openweathermap.org/geo/1.0/direct?q=${nomeCidade}&limit=1&appid=${apiKey}`
            const options = {method: "GET"};

            fetch(url,options)
            .then(res => res.json())
            .then(res =>{

                let coords = {

                    lat: res[0].lat,
                    lon: res[0].lon

                }

                callback(coords, nomeCidade);

            });

        }

        function obterNomeCidadePorCoordenadas(coords){

            const url = `https://api.openweathermap.org/geo/1.0/reverse?lat=${coords.lat}&lon=${coords.lon}&limit=1&appid=${apiKey}`
            const options = {method: "GET"};

            let nomeCidade;

            return fetch(url,options)
            .then(res => res.json())
            .then(res => res[0].local_names.pt);

        }

        function obterClima(coords, nomeCidade){

            const apiUrl = `https://api.openweathermap.org/data/2.5/onecall?lat=${coords.lat}&lon=${coords.lon}&appid=${apiKey}&units=metric&lang=pt_br`
            const options = {method: "GET"};

            fetch(apiUrl, options)
            .then(res => res.json())
            .then(res => {
                
                if (res.message){

                    return tratarErro(res.cod);

                }

                const clima = {

                    nomeCidade: nomeCidade,
                    temp: parseInt(res.hourly[0].temp),
                    temp_min: parseInt(res.daily[0].temp.min),
                    temp_max: parseInt(res.daily[0].temp.max),
                    descricao: capitalize(res.hourly[0].weather[0].description),
                    iconUrl: `https://openweathermap.org/img/wn/${res.hourly[0].weather[0].icon}@2x.png`,

                }

                criarCartao(clima);
                cidadesPesquisadas.push(nomeCidade)
            
            })
            .catch(err => console.log(err))

        }

        function abrirJanela(titulo,texto){

            $("div#janela>div")[0].classList.contains("show") ? $("button#fecharJanela")[0].click(): ""

            $("#titulo-janela").text(titulo);
            $("#texto-janela").text(texto);

            $("button#abrirJanela")[0].click();

        }

        function configurarBackground(){

            const hora = new Date().getHours();

            let bgUrl = "./img/dia.jpg";

            if (hora >= 18 || hora <= 6){

                bgUrl = "./img/noite.jpg";
                $("html").css("--bgColorCartao", "#212529");

            } 

            $("body").css("background-image", `url(${bgUrl})`);

        }

        let cidadesPesquisadas = [];
        let orientacao;

        const orientacaoMediaQuery = window.matchMedia("(orientation:portrait)");
        orientacaoMediaQuery.addEventListener("change", (e)=>verificarOrientacao(e,excluirCartoes));
        verificarOrientacao(orientacaoMediaQuery,excluirCartoes)
        configurarBackground();

        $("form").submit(function(event){

            event.preventDefault();

            let nomeCidade = $("input#cidade").val();

            if (verificarNomeCidade(nomeCidade) == true) return;
            obterCoordenadasPorNomeCidade(nomeCidade, obterClima);

        })

        window.onload = ()=>{

            obterCoordenadasPorGeoLocation(obterClima);

        }

    </script>

</body>
</html>